<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Bio Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#0b0e14; color:#fff; padding:24px; }
    .card { background:#121826; padding:20px; border-radius:16px; max-width:600px; margin:auto; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Ch√†o m·ª´ng b·∫°n!</h2>
    <p>B·∫°n ƒë√£ v∆∞·ª£t link th√†nh c√¥ng üéâ</p>
    <p id="status">‚è≥ ƒêang x·ª≠ l√Ω...</p>
    <p id="key" style="font-size:1.2em; font-weight:bold;"></p>
  </div>

  <!-- Load config ri√™ng -->
  <script src="config.js"></script>

  <script>
    (async () => {
      const params = new URLSearchParams(location.search);
      const sid = params.get("sid");
      if (!sid) {
        document.getElementById("status").textContent = "‚ùå Thi·∫øu tham s·ªë sid!";
        return;
      }

      const newKey = "DUC_" + sid;
      document.getElementById("key").textContent = "üîë Key c·ªßa b·∫°n: " + newKey;

      const { GIST_ID, GIST_FILE, GITHUB_TOKEN } = window.APP_CONFIG;
      const RAW_URL = `https://gist.githubusercontent.com/DucDarling/${GIST_ID}/raw/${GIST_FILE}`;
      const API_URL = `https://api.github.com/gists/${GIST_ID}`;

      try {
        // L·∫•y key.json hi·ªán t·∫°i (cache-buster)
        const resp = await fetch(RAW_URL + "?t=" + Date.now(), { cache: "no-store" });
        let keys = [];
        try { keys = await resp.json(); } catch {}

        if (!keys.includes(newKey)) {
          keys.push(newKey);

          const patchRes = await fetch(API_URL, {
            method: "PATCH",
            headers: {
              "Authorization": "token " + GITHUB_TOKEN,
              "Accept": "application/vnd.github.v3+json",
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              files: { [GIST_FILE]: { content: JSON.stringify(keys, null, 2) } }
            })
          });

          if (!patchRes.ok) {
            const txt = await patchRes.text();
            document.getElementById("status").textContent = "‚ùå L·ªói ghi key: " + txt;
            return;
          }
        }

        document.getElementById("status").textContent = "‚úÖ Key ƒë√£ l∆∞u v√†o h·ªá th·ªëng. H√£y copy key ·ªü tr√™n v√† d√°n v√†o tool.";
      } catch (err) {
        document.getElementById("status").textContent = "‚ùå L·ªói k·∫øt n·ªëi gist: " + err.message;
      }
    })();
  </script>
</body>
</html>
